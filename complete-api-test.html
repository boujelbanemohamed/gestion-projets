<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Complet des APIs Front & Back</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .content {
            padding: 40px;
        }
        .api-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin: 20px 0;
            overflow: hidden;
        }
        .section-header {
            background: #1e293b;
            color: white;
            padding: 20px;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .section-content {
            padding: 20px;
        }
        .api-test {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .api-test:last-child {
            border-bottom: none;
        }
        .api-info {
            flex: 1;
        }
        .api-name {
            font-weight: 600;
            color: #1e293b;
        }
        .api-endpoint {
            font-size: 0.875rem;
            color: #64748b;
            font-family: 'Courier New', monospace;
        }
        .api-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }
        .status-pass { background: #dcfce7; color: #166534; }
        .status-fail { background: #fef2f2; color: #dc2626; }
        .status-warn { background: #fef3c7; color: #92400e; }
        .status-loading { background: #dbeafe; color: #1e40af; }
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
        }
        .btn:hover { background: #4338ca; }
        .summary {
            background: #f1f5f9;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .summary-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }
        .summary-number {
            font-size: 2rem;
            font-weight: 800;
            margin: 0;
        }
        .summary-label {
            color: #64748b;
            font-size: 0.9rem;
            margin: 5px 0 0 0;
        }
        .log {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Test Complet des APIs Front & Back</h1>
            <p>V√©rification exhaustive de toutes les APIs de votre plateforme</p>
        </div>
        
        <div class="content">
            <div style="text-align: center;">
                <button class="btn" onclick="runCompleteAPITest()">üöÄ Tester Toutes les APIs</button>
                <button class="btn" onclick="testSupabaseAPIs()">üóÑÔ∏è Test Supabase</button>
                <button class="btn" onclick="testBackendAPIs()">‚öôÔ∏è Test Backend</button>
                <button class="btn" onclick="showLog()">üìã Logs</button>
            </div>

            <div id="summary" class="summary" style="display: none;">
                <h3>üìä R√©sum√© des Tests</h3>
                <div id="summary-content" class="summary-grid"></div>
            </div>

            <!-- APIs Supabase -->
            <div class="api-section">
                <div class="section-header">üóÑÔ∏è APIs Supabase (Production)</div>
                <div class="section-content" id="supabase-apis"></div>
            </div>

            <!-- APIs Backend Local -->
            <div class="api-section">
                <div class="section-header">‚öôÔ∏è APIs Backend Local</div>
                <div class="section-content" id="backend-apis"></div>
            </div>

            <!-- APIs Frontend -->
            <div class="api-section">
                <div class="section-header">üé® Services Frontend</div>
                <div class="section-content" id="frontend-apis"></div>
            </div>

            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://obdadipsbbrlwetkuyui.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iZGFkaXBzYmJybHdldGt1eXVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODgxMjMsImV4cCI6MjA3MDA2NDEyM30.jracnTOp7Y0QBTbt7qjY4076aBqh3pq7DR-rU_U33fo';
        const BACKEND_URL = 'http://localhost:3000/api';

        let testResults = {
            supabase: {},
            backend: {},
            frontend: {}
        };

        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showLog() {
            const logDiv = document.getElementById('log');
            logDiv.style.display = logDiv.style.display === 'none' ? 'block' : 'none';
        }

        async function testStorageAPI(api) {
            log('üóÑÔ∏è Test avanc√© du Storage API...');

            try {
                // Test 1: Endpoint principal
                const objectResponse = await fetch(`${SUPABASE_URL}/storage/v1/object`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (objectResponse.ok) {
                    log('‚úÖ Storage object endpoint: OK');

                    // Test 2: Liste des buckets
                    try {
                        const bucketResponse = await fetch(`${SUPABASE_URL}/storage/v1/bucket`, {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        });

                        if (bucketResponse.ok) {
                            const buckets = await bucketResponse.json();
                            updateAPIStatus('supabase', api.name, 'pass', `${api.description} (${buckets.length} buckets)`);
                            testResults.supabase[api.name] = { status: 'pass', count: buckets.length };
                            log(`‚úÖ Storage API: Enti√®rement fonctionnel (${buckets.length} buckets)`);
                        } else {
                            updateAPIStatus('supabase', api.name, 'warn', `${api.description} (Service actif, buckets restreints)`);
                            testResults.supabase[api.name] = { status: 'partial' };
                            log('‚ö†Ô∏è Storage API: Service actif mais buckets restreints');
                        }
                    } catch (bucketError) {
                        updateAPIStatus('supabase', api.name, 'warn', `${api.description} (Service actif, configuration limit√©e)`);
                        testResults.supabase[api.name] = { status: 'partial' };
                        log('‚ö†Ô∏è Storage API: Service actif mais configuration limit√©e');
                    }
                } else if (objectResponse.status === 404) {
                    // Service Storage non activ√©
                    updateAPIStatus('supabase', api.name, 'warn', `${api.description} (Service non activ√© - Optionnel)`);
                    testResults.supabase[api.name] = { status: 'disabled' };
                    log('‚ÑπÔ∏è Storage API: Service non activ√© dans Supabase (optionnel)');
                } else if (objectResponse.status === 401 || objectResponse.status === 403) {
                    updateAPIStatus('supabase', api.name, 'warn', `${api.description} (Service prot√©g√©)`);
                    testResults.supabase[api.name] = { status: 'protected' };
                    log('üîí Storage API: Service prot√©g√© par permissions');
                } else {
                    updateAPIStatus('supabase', api.name, 'fail', `${api.description} (Erreur ${objectResponse.status})`);
                    testResults.supabase[api.name] = { status: 'fail', error: objectResponse.status };
                    log(`‚ùå Storage API: Erreur ${objectResponse.status}`);
                }
            } catch (error) {
                updateAPIStatus('supabase', api.name, 'warn', `${api.description} (Non configur√© - Application fonctionnelle)`);
                testResults.supabase[api.name] = { status: 'optional' };
                log(`‚ÑπÔ∏è Storage API: Non configur√© (${error.message}) - Application reste fonctionnelle`);
            }
        }

        function updateAPIStatus(section, apiName, status, message = '') {
            const container = document.getElementById(`${section}-apis`);
            const existingTest = container.querySelector(`[data-api="${apiName}"]`);
            
            if (existingTest) {
                const statusElement = existingTest.querySelector('.api-status');
                statusElement.className = `api-status status-${status}`;
                statusElement.textContent = message || (status === 'pass' ? '‚úÖ OK' : status === 'fail' ? '‚ùå √âchec' : '‚ö†Ô∏è Partiel');
            } else {
                const testDiv = document.createElement('div');
                testDiv.className = 'api-test';
                testDiv.setAttribute('data-api', apiName);
                testDiv.innerHTML = `
                    <div class="api-info">
                        <div class="api-name">${apiName}</div>
                        <div class="api-endpoint">${message}</div>
                    </div>
                    <div class="api-status status-${status}">
                        ${status === 'pass' ? '‚úÖ OK' : status === 'fail' ? '‚ùå √âchec' : status === 'loading' ? 'üîÑ Test...' : '‚ö†Ô∏è Partiel'}
                    </div>
                `;
                container.appendChild(testDiv);
            }
        }

        async function testSupabaseAPIs() {
            log('üóÑÔ∏è Test des APIs Supabase...');

            const supabaseAPIs = [
                { name: 'REST API', endpoint: '/rest/v1/', description: 'API REST principale' },
                { name: 'Auth API', endpoint: '/auth/v1/settings', description: 'Service d\'authentification' },
                { name: 'Storage API', endpoint: '/storage/v1/object', description: 'Stockage de fichiers', optional: true, testBucket: true },
                { name: 'D√©partements', endpoint: '/rest/v1/departments?select=*', description: 'Table d√©partements' },
                { name: 'Projets', endpoint: '/rest/v1/projects?select=*', description: 'Table projets' },
                { name: 'Utilisateurs', endpoint: '/rest/v1/users?select=*', description: 'Table utilisateurs' },
                { name: 'PV R√©union', endpoint: '/rest/v1/meeting_minutes?select=*', description: 'Table PV de r√©union' }
            ];

            for (const api of supabaseAPIs) {
                updateAPIStatus('supabase', api.name, 'loading', api.description);

                try {
                    // Test sp√©cial pour Storage API
                    if (api.name === 'Storage API') {
                        await testStorageAPI(api);
                        continue;
                    }

                    const response = await fetch(`${SUPABASE_URL}${api.endpoint}`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const count = Array.isArray(data) ? data.length : 'N/A';
                        updateAPIStatus('supabase', api.name, 'pass', `${api.description} (${count} items)`);
                        testResults.supabase[api.name] = { status: 'pass', count };
                        log(`‚úÖ ${api.name}: OK (${count} items)`);
                    } else if (response.status === 401 || response.status === 403) {
                        updateAPIStatus('supabase', api.name, 'warn', `${api.description} (RLS prot√©g√©)`);
                        testResults.supabase[api.name] = { status: 'protected' };
                        log(`üîí ${api.name}: Prot√©g√© par RLS (normal)`);
                    } else if (response.status === 404 && api.optional) {
                        updateAPIStatus('supabase', api.name, 'warn', `${api.description} (Non configur√© - Optionnel)`);
                        testResults.supabase[api.name] = { status: 'optional' };
                        log(`‚ö†Ô∏è ${api.name}: Service optionnel non configur√©`);
                    } else {
                        updateAPIStatus('supabase', api.name, 'fail', `${api.description} (Status ${response.status})`);
                        testResults.supabase[api.name] = { status: 'fail', error: response.status };
                        log(`‚ùå ${api.name}: Erreur ${response.status}`);
                    }
                } catch (error) {
                    updateAPIStatus('supabase', api.name, 'fail', `${api.description} (Erreur r√©seau)`);
                    testResults.supabase[api.name] = { status: 'fail', error: error.message };
                    log(`‚ùå ${api.name}: ${error.message}`);
                }

                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }

        async function testBackendAPIs() {
            log('‚öôÔ∏è Test des APIs Backend...');
            
            const backendAPIs = [
                { name: 'Health Check', endpoint: '/health', description: 'V√©rification serveur' },
                { name: 'Test Route', endpoint: '/test', description: 'Route de test' },
                { name: 'Auth Login', endpoint: '/auth/login', description: 'Authentification', method: 'POST' },
                { name: 'Projets All', endpoint: '/projects/all', description: 'Tous les projets' },
                { name: 'Projets', endpoint: '/projects', description: 'API projets' },
                { name: 'Rubriques', endpoint: '/rubriques', description: 'API rubriques' },
                { name: 'Meeting Minutes', endpoint: '/meeting-minutes', description: 'PV de r√©union' },
                { name: 'D√©partements', endpoint: '/departments', description: 'API d√©partements' },
                { name: 'Utilisateurs', endpoint: '/users', description: 'API utilisateurs' }
            ];

            for (const api of backendAPIs) {
                updateAPIStatus('backend', api.name, 'loading', api.description);
                
                try {
                    const options = {
                        method: api.method || 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    };

                    if (api.method === 'POST' && api.name === 'Auth Login') {
                        options.body = JSON.stringify({
                            email: 'test@example.com',
                            password: 'test123'
                        });
                    }

                    const response = await fetch(`${BACKEND_URL}${api.endpoint}`, options);

                    if (response.ok) {
                        const data = await response.json();
                        const info = data.projects ? `${data.projects.length} projets` : 
                                   data.message ? data.message : 'OK';
                        updateAPIStatus('backend', api.name, 'pass', `${api.description} (${info})`);
                        testResults.backend[api.name] = { status: 'pass', data };
                        log(`‚úÖ ${api.name}: OK`);
                    } else {
                        updateAPIStatus('backend', api.name, 'warn', `${api.description} (Status ${response.status})`);
                        testResults.backend[api.name] = { status: 'warn', error: response.status };
                        log(`‚ö†Ô∏è ${api.name}: Status ${response.status}`);
                    }
                } catch (error) {
                    updateAPIStatus('backend', api.name, 'fail', `${api.description} (Non accessible)`);
                    testResults.backend[api.name] = { status: 'fail', error: error.message };
                    log(`‚ùå ${api.name}: ${error.message}`);
                }

                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }

        async function testFrontendServices() {
            log('üé® Test des services Frontend...');
            
            const frontendTests = [
                { name: 'React App', test: () => document.querySelector('#root') && document.querySelector('#root').children.length > 0 },
                { name: 'Supabase Client', test: () => window.supabase || localStorage.getItem('sb-obdadipsbbrlwetkuyui-auth-token') },
                { name: 'API Service', test: () => window.fetch && typeof window.fetch === 'function' },
                { name: 'Local Storage', test: () => window.localStorage && typeof window.localStorage.setItem === 'function' },
                { name: 'Session Storage', test: () => window.sessionStorage && typeof window.sessionStorage.setItem === 'function' },
                { name: 'Navigation', test: () => document.querySelector('nav') || document.querySelector('[role="navigation"]') },
                { name: 'Formulaires', test: () => document.querySelectorAll('form, [role="dialog"]').length > 0 },
                { name: 'Boutons UI', test: () => document.querySelectorAll('button').length > 5 }
            ];

            for (const test of frontendTests) {
                updateAPIStatus('frontend', test.name, 'loading', 'V√©rification...');
                
                try {
                    const result = test.test();
                    if (result) {
                        updateAPIStatus('frontend', test.name, 'pass', 'Fonctionnel');
                        testResults.frontend[test.name] = { status: 'pass' };
                        log(`‚úÖ ${test.name}: OK`);
                    } else {
                        updateAPIStatus('frontend', test.name, 'fail', 'Non fonctionnel');
                        testResults.frontend[test.name] = { status: 'fail' };
                        log(`‚ùå ${test.name}: √âchec`);
                    }
                } catch (error) {
                    updateAPIStatus('frontend', test.name, 'fail', 'Erreur');
                    testResults.frontend[test.name] = { status: 'fail', error: error.message };
                    log(`‚ùå ${test.name}: ${error.message}`);
                }

                await new Promise(resolve => setTimeout(resolve, 200));
            }
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summary-content');
            
            let totalTests = 0;
            let passedTests = 0;
            let protectedTests = 0;
            let failedTests = 0;

            Object.values(testResults).forEach(section => {
                Object.values(section).forEach(result => {
                    totalTests++;
                    if (result.status === 'pass') passedTests++;
                    else if (result.status === 'protected' || result.status === 'warn' || result.status === 'partial' || result.status === 'disabled' || result.status === 'optional') protectedTests++;
                    else failedTests++;
                });
            });

            const score = Math.round((passedTests / totalTests) * 100);

            summaryContent.innerHTML = `
                <div class="summary-item">
                    <div class="summary-number" style="color: #059669;">${score}%</div>
                    <div class="summary-label">Score Global</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" style="color: #059669;">${passedTests}</div>
                    <div class="summary-label">APIs Fonctionnelles</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" style="color: #f59e0b;">${protectedTests}</div>
                    <div class="summary-label">APIs Prot√©g√©es</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" style="color: #ef4444;">${failedTests}</div>
                    <div class="summary-label">APIs en √âchec</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" style="color: #6b7280;">${totalTests}</div>
                    <div class="summary-label">Total Test√©es</div>
                </div>
            `;

            summaryDiv.style.display = 'block';

            log(`üìä R√©sum√©: ${score}% - ${passedTests}/${totalTests} APIs fonctionnelles`);
        }

        async function runCompleteAPITest() {
            log('üöÄ D√©marrage du test complet des APIs...');
            testResults = { supabase: {}, backend: {}, frontend: {} };
            
            await testSupabaseAPIs();
            await testBackendAPIs();
            await testFrontendServices();
            
            updateSummary();
            log('‚úÖ Test complet termin√© !');
        }

        // Auto-test au chargement
        setTimeout(() => {
            log('üîç Lancement automatique du test des APIs...');
            runCompleteAPITest();
        }, 2000);
    </script>
</body>
</html>
